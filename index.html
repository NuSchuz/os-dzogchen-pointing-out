<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OpenSpace — Pointing-Out Teachings (V8)</title>
  <style>
    :root{
      --bg:#000000;
      --fg:#ffffff;
      --muted:#8a8a8a;
      --cardTop:rgba(32,32,40,0.92);
      --cardBottom:rgba(8,8,12,0.88);
      --btn:#1e1e1e;
      --btnHover:#2b2b2b;
      --radius:14px;
    }

    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden; /* prevents vertical scrolling entirely */
    }
    
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
    
      background: linear-gradient(
        135deg,
        #0b0b12 0%,
        #000000 50%,
        #000000 100%
      );
    
      color: var(--fg);
    
      display: flex;
      justify-content: center;
      align-items: center;
    
      padding-top: 50px;   /* slightly reduced for better fit */
      padding-bottom: 0;   /* unnecessary with overflow hidden */
    }
    
    #container{
      width:min(720px,96vw);
      max-width:820px;
      margin-top: -40px;   /* ← moves the centered content upward just a bit */
    }

    /* Header: OpenSpace (big) + subtitle + info icon */
    #headerColumn{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-bottom:14px;
    }

    #titleMain{
      margin:0;
      font-weight:700;
      font-size:1.5rem;
      line-height:1.2;
      letter-spacing:0.02em;
    }

    #subHeaderRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }

    #titleSub{
      margin:0;
      font-weight:500;
      font-size:1.02rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color:var(--muted);
    }

    #infoBtn{
      flex:0 0 auto;
      width:22px;
      height:22px;
      border-radius:50%;
      border:none;
      padding:0;
      background:transparent;
      cursor:pointer;
      display:none; /* shown when a teaching is selected */
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 24 24' stroke='%23ffffff' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='12' r='9'/%3E%3Cline x1='12' y1='10' x2='12' y2='16'/%3E%3Ccircle cx='12' cy='7' r='1'/%3E%3C/svg%3E");
      background-repeat:no-repeat;
      background-position:center;
      background-size:18px;
      opacity:0.85;
      transition:opacity .15s ease, transform .15s ease;
    }
    #infoBtn:hover{ opacity:1; transform:translateY(-1px); }

    /* Sound row under subtitle */
    #soundRow{
      display:flex;
      justify-content:flex-end;
      margin-top:2px;
    }
    #soundBtn{
      width:22px;
      height:22px;
      border-radius:50%;
      border:none;
      padding:0;
      background:transparent;
      cursor:pointer;
      display:inline-block;
      background-repeat:no-repeat;
      background-position:center;
      background-size:18px;
      opacity:0.75;
      transition:opacity .15s ease, transform .15s ease;
    }
    #soundBtn:hover{
      opacity:1;
      transform:translateY(-1px);
    }

    .mode-extra-button {
      background: var(--btn);
      color: var(--fg);
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      margin: 10px 0;
      cursor: pointer;
      font-size: 1rem;
      width: 100%;
      transition: background .15s, transform .15s;
    }
    
    .mode-extra-button:hover {
      background: var(--btnHover);
      transform: translateY(-1px);
    }

    /* Card: floating, gradient, soft shadow */
    #card{
      background:linear-gradient(180deg, var(--cardTop), var(--cardBottom));
      padding:20px 20px 22px 20px;
      border-radius:var(--radius);
      box-shadow:0 12px 40px rgba(0,0,0,.45);
      position:relative;
      backdrop-filter:blur(8px);
      border:1px solid rgba(255,255,255,0.04);
      transition:transform .25s ease, box-shadow .25s ease;
    }
    #card::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(circle at top, rgba(255,255,255,0.07) 0, transparent 55%),
        linear-gradient(to bottom, rgba(255,255,255,0.02), transparent 40%);
      pointer-events:none;
      opacity:0.8;
    }
    #card:hover{
      transform:translateY(-2px);
      box-shadow:0 16px 48px rgba(0,0,0,.55);
    }

    #content{
      min-height:110px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      border-radius:12px;
      background:rgba(255,255,255,0.01);
      color:var(--fg);
      font-size:1.05rem;
      line-height:1.5;
      text-align:center;
      opacity:1;
      transition:opacity .45s ease;
    }

    .controls{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:center;
      margin-top:16px;
    }

    button{
      background:var(--btn);
      color:var(--fg);
      border:none;
      padding:10px 14px;
      border-radius:10px;
      cursor:pointer;
      font-size:0.95rem;
      transition:
        opacity .12s,
        transform .12s,
        background .12s,
        box-shadow .12s;
      box-shadow:0 4px 12px rgba(0,0,0,0.4);
    }
    button:hover:not(:disabled){
      background:var(--btnHover);
      transform:translateY(-1px);
      box-shadow:0 6px 18px rgba(0,0,0,0.5);
    }
    button:disabled{
      opacity:.32;
      cursor:default;
      background:#0a0a0a;
      color:var(--muted);
      box-shadow:none;
    }

    #stepBtn,#cycleBtn{
      width:52px;
      height:52px;
      border-radius:12px;
      font-size:18px;
      padding:0;
    }

    #anchorBtn{
      width:38px;
      height:34px;
      border-radius:8px;
      padding:0;
      display:flex;
      align-items:center;
      justify-content:center;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' stroke='%23ffffff' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='12' cy='6' r='2'/%3E%3Cpath d='M12 8v10'/%3E%3Cpath d='M6 14c0 3.3 2.7 6 6 6s6-2.7 6-6'/%3E%3Cpath d='M6 14l2 2'/%3E%3Cpath d='M18 14l-2 2'/%3E%3C/svg%3E");
      background-repeat:no-repeat;
      background-position:center;
      background-size:20px;
    }

    /* Menu toggle + menu bar (left-aligned, small) */
    #menuToggleRow{
      display:flex;
      justify-content:flex-start;
      margin-bottom:6px;
    }
    #menuToggleBtn{
      width:26px;
      height:26px;
      padding:0;
      border-radius:8px;
      background:transparent;
      box-shadow:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' stroke='%23ffffff' stroke-width='2' fill='none' stroke-linecap='round'%3E%3Cline x1='4' y1='7' x2='20' y2='7'/%3E%3Cline x1='4' y1='12' x2='20' y2='12'/%3E%3Cline x1='4' y1='17' x2='20' y2='17'/%3E%3C/svg%3E");
      background-repeat:no-repeat;
      background-position:center;
      background-size:20px;
      opacity:0.9;
      transition:opacity .12s ease, transform .12s ease, background .12s ease;
    }
    #menuToggleBtn:hover{
      opacity:1;
      transform:translateY(-1px);
    }

    #menuBar {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
    
      /* NEW — add consistent spacing above and below */
      margin-top: 12px;
      margin-bottom: 12px;
    }
    
    #menuBar button {
      flex: 1 1 calc(50% - 10px);
      text-align: center;
      padding: 8px 10px;
      font-size: 0.82rem;
    }
    
    #menuBar button:hover {
      background:rgba(255,255,255,0.10);
      border-color:rgba(255,255,255,0.15);
      transform:translateY(-1px);
    }
    
    /* Anchor area */
    #anchorArea{
      margin-top:12px;
      min-height:46px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #anchorText{
      opacity:0;
      transition:opacity 15000ms ease;
      color:var(--muted);
      text-align:center;
      max-width:82%;
      font-size:0.95rem;
      line-height:1.45;
    }

    /* Info modal */
    #infoModal{
      display:none;
      position:fixed;
      top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.75);
      z-index:1100;
      align-items:center;
      justify-content:center;
      padding:20px;
      box-sizing:border-box;
    }
    #infoModalContent{
      background:rgba(10,10,12,0.96);
      color:var(--fg);
      padding:18px;
      border-radius:12px;
      max-width:420px;
      width:100%;
      max-height:80%;
      overflow:auto;
      position:relative;
      box-shadow:0 18px 50px rgba(0,0,0,.7);
      font-size:0.95rem;
      line-height:1.45;
      border:1px solid rgba(255,255,255,0.05);
    }
    #closeModal{
      position:absolute;
      top:10px;
      right:12px;
      font-size:18px;
      background:none;
      border:none;
      color:var(--muted);
      cursor:pointer;
    }
    #infoTitle{
      margin-top:0;
      margin-bottom:6px;
      font-size:1.02rem;
      font-weight:600;
    }

    @media (max-width:480px){
      #content{ font-size:0.98rem; min-height:84px }
      #stepBtn, #cycleBtn{ width:48px; height:48px; font-size:18px }
      #titleMain{ font-size:1.35rem; }
      #titleSub{ font-size:0.98rem; }
    }
  </style>
</head>
<body>
  <div id="container">
    <!-- Header -->
    <div id="headerColumn">
      <h1 id="titleMain">OpenSpace ཨཱཿ</h1>
      <div id="subHeaderRow">
        <h2 id="titleSub">Pointing-Out Teachings</h2>
        <button id="infoBtn" aria-label="Help"></button>
      </div>
      <div id="soundRow">
        <button id="soundBtn" aria-label="Toggle sound"></button>
      </div>
    </div>

    <!-- Menu toggle -->
    <div id="menuToggleRow">
      <button id="menuToggleBtn" aria-label="Toggle teaching menu"></button>
    </div>

    <!-- Teaching selector: Trekchö, Mahamudra, Freeform (Freeform last) -->
    <div id="menuBar">
      <button id="rushenBtn">Inner Mind Rushen*</button>
      <button id="mahaBtn">Mahamudra Pointing-Out</button>
      <button id="dzPOBtn">Dzogchen Pointing-Out</button>
      <button id="trekchoBtn">Trekchö</button>
      <button id="dzogchenBtn">Dzogchen Freeform</button>
    </div>

    <div id="card">
      <div id="content">Select a teaching to begin.</div>

      <div class="controls" aria-hidden="false">
        <button id="stepBtn" aria-label="Step" disabled style="display:none;">●</button>
        <button id="cycleBtn" aria-label="Next iteration" disabled style="display:none;">○</button>
      </div>

      <div style="display:flex;flex-direction:column;align-items:center">
        <div style="margin-top:10px;">
          <button id="anchorBtn" aria-label="Anchor" disabled style="display:none;"></button>
        </div>
        <div id="anchorArea"><div id="anchorText"></div></div>
      </div>
    </div>
  </div>

  <!-- Info modal -->
  <div id="infoModal" role="dialog" aria-hidden="true">
    <div id="infoModalContent">
      <button id="closeModal" aria-label="Close help">×</button>
      <h3 id="infoTitle">How this works</h3>
      <div id="infoBody"></div>
    </div>
  </div>

  <script>
    /* ---------- Audio setup ---------- */
    let audioCtx = null;
    let soundEnabled = true;
    let schumannNodes = null;
    // Rushen module state
    let currentRushenIndex = 0;
    let currentRushenPath = null;

    const SOUND_ICON_ON =
      "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 24 24' stroke='%23ffffff' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolygon points='5 9 9 9 12 6 12 18 9 15 5 15 5 9'/%3E%3Cpath d='M16 10c1.333 1.333 1.333 2.667 0 4'/%3E%3Cpath d='M18.5 7.5c2.5 2.5 2.5 6.5 0 9'/%3E%3C/svg%3E";

    const SOUND_ICON_OFF =
      "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 24 24' stroke='%23ffffff' stroke-width='2' fill='none' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolygon points='5 9 9 9 12 6 12 18 9 15 5 15 5 9'/%3E%3Cline x1='16' y1='9' x2='20' y2='13'/%3E%3Cline x1='20' y1='9' x2='16' y2='13'/%3E%3C/svg%3E";

    function ensureAudioCtx(){
      if(!audioCtx){
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
    }

    function playChime() {
      if (!soundEnabled) return;
    
      ensureAudioCtx();
    
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
    
      osc.type = "sine";
      osc.frequency.setValueAtTime(528, audioCtx.currentTime);
    
      gain.gain.setValueAtTime(0.18, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.0008, audioCtx.currentTime + 3.5);
    
      osc.connect(gain).connect(audioCtx.destination);
    
      osc.start();
      osc.stop(audioCtx.currentTime + 3.6);
    }

    function startSchumann(){
      ensureAudioCtx();
      stopSchumann();
      if(audioCtx.state === "suspended") audioCtx.resume();

      const carrier = audioCtx.createOscillator();
      carrier.type = "sine";
      carrier.frequency.value = 126; // Hz

      const gain = audioCtx.createGain();
      gain.gain.value = 0.15;

      const mod = audioCtx.createOscillator();
      mod.type = "sine";
      mod.frequency.value = 7.83; // Schumann resonance

      const modGain = audioCtx.createGain();
      modGain.gain.value = 0.07; // pulsing depth

      mod.connect(modGain).connect(gain.gain);
      carrier.connect(gain).connect(audioCtx.destination);

      carrier.start();
      mod.start();

      schumannNodes = { carrier, mod, gain, modGain };
    }

    function stopSchumann(){
      if(schumannNodes){
        try {
          schumannNodes.carrier.stop();
          schumannNodes.mod.stop();
        } catch(e){}
        schumannNodes = null;
      }
    }

    function playSolfeggio(freq){
      ensureAudioCtx();
      if(audioCtx.state === "suspended") audioCtx.resume();

      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      osc.type = "sine";
      osc.frequency.value = freq;

      const now = audioCtx.currentTime;
      gain.gain.setValueAtTime(0, now);
      gain.gain.linearRampToValueAtTime(0.15, now + 0.15);
      gain.gain.linearRampToValueAtTime(0, now + 0.45);

      osc.connect(gain).connect(audioCtx.destination);
      osc.start(now);
      osc.stop(now + 0.6);
    }

    function playPhaseTone(phase){
      if(!soundEnabled) return;
      // Dzogchen phases: 0→396, 1→417, 2→528, 3→639 Hz
      //if(phase === 0) /*playSolfeggio(396);*/
      //else if(phase === 1) /*playSolfeggio(417);*/
      //else if(phase === 2) /*playSolfeggio(528);*/
      //else if(phase === 3) /*playSolfeggio(639);*/
    }

    // ---------------------------
    // INNER MIND RUSHEN MODULE
    // ---------------------------
    
    const rushenIntro = [
      "Inner Mind Rushen is a preliminary practice, whose revelation is found across spiritual traditions.",
      "It is not exotic or secret. It reveals what is already present beneath habit.",
      "Sit in a stable, comfortable posture. Spine straight but relaxed. Shoulders soft. Jaw loose. Gaze open.",
      "Let verbal activity quiet. Do not suppress thoughts; let them drift without engagement.",
      "This practice reveals the nature of mind by searching where experience is occurring.",
      "There are two methods. Choose the approach that feels natural."
    ];
    
    const rushenWide = [
      "Let attention spread wide. Not focused, not narrow, not aimed.",
      "Allow sensations, sounds, and thoughts to arise naturally within a wide, effortless field.",
      "As attention relaxes, the background that holds all experience becomes more evident.",
      "Awareness is not created. It is already here.",
      "This openness has been described in many traditions: early Buddhism, Vedanta, Sufi witnessing, Christian contemplative prayer, Taoist non-striving, indigenous sky-mind practices, etc.",
      "Different words, same recognition.",
      "Rest without modifying anything. Let the natural clarity show itself."
    ];
    
    const rushenImagery = [
      "Hold a simple mental image lightly: a stone, a cup, a leaf — distinct enough to sense, but without strain.",
      "Ask gently: 'Where is this occurring?'",
      "Do not think the answer. Let attention move toward the felt location of the image.",
      "Search the body: head, throat, chest, belly, spine, hands, feet. Notice where the image seems to be happening.",
      "Then search outward: in front, behind, above, below, and to both sides.",
      "Let attention feel into the 'where' — as if sensing something closer than thought or sensation.",
      "Notice how the image dissolves or slips away.",
      "Attend to what the image dissolved into. That vanishing reveals something important."
    ];
    
    const rushenResolve = [
      "If mind cannot be found in the body or in space, notice what remains.",
      "A knowing that does not come from a location.",
      "A clarity closer than breath.",
      "A presence that has been here in every moment of your life.",
      "This is why so many traditions describe awakening as recognition rather than attainment.",
      "Open, clear, locationless awareness is not created. It was never absent.",
      "Rest naturally in this unconstructed openness.",
      "Do not try to hold it. Do not describe it. Do not chase it.",
      "Let the natural state show itself without interference."
    ];
    
    /* ---------- Dzogchen Freeform pools ---------- */
    const phenomena = [
      "Notice the next thought that appears.","Notice the next emotion that surfaces.","Notice any bodily sensation you can feel.",
      "Notice the first sound you hear right now.","Notice a memory that comes to mind.","Notice a fleeting image in your mind.",
      "Notice an impulse or urge that arises.","Notice tension or relaxation in your body.","Notice any taste, smell, or subtle sensation.",
      "Notice the feeling of your posture.","Notice a judgment or evaluation as it arises.","Notice any desire or aversion appearing.",
      "Notice a flicker of attention in your mind.","Notice a pause, blank, or gap in thought.","Notice the flow of breath without changing it.",
      "Notice a subtle feeling of comfort or discomfort.","Notice curiosity arising in your awareness.","Notice agitation or restlessness.",
      "Notice a fleeting visual impression in the environment.","Notice an internal dialogue or narrative forming.","Notice a small ache or ease in the body.",
      "Notice a passing preference or dislike.","Notice the edges of your attention.","Notice a faint mental image that appears.",
      "Notice the sound your clothes or chair makes.","Notice a recent thought about the future.","Notice the feeling behind a remembered word.",
      "Notice the subtle holding in your hands or fingers.","Notice any urge to look away or avoid.","Notice a gentle warmth or coolness in the skin.",
      "Notice the light changing in the room.","Notice the rhythm of your heartbeat.","Notice the space between breaths.",
      "Notice a smell from the environment.","Notice a memory from childhood.","Notice a small muscle twitch.",
      "Notice your feet touching the floor.","Notice your hands resting.","Notice the temperature in your fingers.",
      "Notice the sound of your own breathing.","Notice the weight of your body on the chair.","Notice subtle thoughts passing.",
      "Notice tension in your jaw or face.","Notice a shift in your posture.","Notice your eyelids and gaze.",
      "Notice a fleeting emotion briefly.","Notice a color you hadn’t observed.","Notice a lingering mental image.",
      "Notice subtle movement in your hands.","Notice a background noise appearing.","Notice a faint smell lingering.",
      "Notice a mental habit.","Notice the pulse in your temples.","Notice any urge to adjust your body.",
      "Notice the temperature of your breath.","Notice the sense of balance in sitting.","Notice the horizon or edge of vision.",
      "Notice a faint itch or touch.","Notice the tension in shoulders or neck.",
      "Notice subtle emotional tones beneath thoughts.","Notice the texture of the present moment.","Notice openness behind sensation.",
      "Notice the movement of attention itself.","Notice how sound arises unbidden.","Notice stillness behind all motion.",
      "Notice the immediate presence before labeling.","Notice the rawness of perception.","Notice how a thought fades on its own.",
      "Notice the boundary between self and sensation dissolving."
    ];

    const spaceCues = [
      "Now notice the space in which that appears.","Shift from the arising object to the openness it inhabits.",
      "Let the image soften; sense the formless ground hosting it.","Notice the simple knowing that doesn't grab the content.",
      "Sense the ungraspable background where this shows up.","Without changing anything, sense the openness that's aware.",
      "Notice how the appearance is simply occurring in this field.","Feel the space that is present even when form is vivid.",
      "Note the clarity that notices without effort.","Allow attention to rest in the open knowing around the object.",
      "Sense the nonreferential space behind the appearance.","Notice that the space doesn't need the content to be itself.",
      "Notice the stillness that contains motion and thought.","Sense how this shows up and shows itself without you doing anything.",
      "Let the background be known as background, not a new object.",
      "Notice the mind’s awareness as the container.","Observe the openness holding all forms.","Feel the spaciousness beneath thoughts.",
      "Rest in the awareness observing itself.","Notice the clarity pervading the mental landscape.","Allow the openness to be self-evident.",
      "Notice how objects arise and dissolve in space.","Sense the field where attention rests naturally.","Notice the horizon of awareness encompassing everything.",
      "Allow the mind’s natural presence to be felt.","Notice the luminous clarity behind sensations.","Rest in the unbounded ground of mind.",
      "Notice the gap between mental events.","Observe how awareness remains unshaken.","Sense the non-dual openness of this moment.",
      "Notice that awareness has no edges.","Sense the expanse that holds even contraction.","Notice how appearances float in openness.",
      "Feel the inseparability of space and movement.","Sense the vividness and spaciousness as one.","Notice the transparency of the arising phenomenon.",
      "Let the openness reveal itself as naturally present.","Rest in the boundlessness that is already here."
    ];

    const revelationCues = [
      "This openness wasn't created just now.","You didn't produce this space — it's already present.",
      "The object arose and passed; the knowing remained.","The openness is unchanged by whatever appears.",
      "You cannot step outside this awareness — it's the ground of all.","This seeing is not something you must assemble.",
      "Even when unnoticing occurs, it too arises in the same space.","No addition is required for this to be present.",
      "This is not a state to obtain; it is what appears in all states.","Recognize that nothing could be missing from this field.",
      "This awareness is prior to concept.","Notice the primordial clarity is always present.","The ground of mind is luminous and open.",
      "All arising is within the natural state.","No effort can create this space; it simply is.","Even confusion arises in this openness.",
      "Recognize the immediacy of presence.","No object can limit this awareness.","This is the natural state, already complete.",
      "Everything unfolds within awareness without interference.","Awareness does not come or go.","The clarity of mind is timeless.",
      "The ground is self-revealing.","The nature of awareness is inseparable from its display.",
      "Nothing can obscure the essence, only your noticing.","All movement is the radiance of awareness.","Rigpa is present even when unnoticed.",
      "The essence has never been altered."
    ];

    const restingCues = [
      "Rest here for a moment.","Let everything be exactly as it is.","No need to hold the view; notice it holds itself.",
      "There's nothing to maintain and nothing to lose.","Simply remain in this effortless openness.","Allow the moment to be as it is without doing.",
      "Stay with the felt sense of not having to fix anything.","Breathe lightly and rest in what is aware.",
      "Allow awareness to rest naturally.","Notice the ease of simply being.","No need to interfere with experience.",
      "Rest in the natural rhythm of mind.","Let each moment be sufficient unto itself.","Feel the spaciousness beneath all phenomena.",
      "Notice the effortless continuity of presence.","Relax into the unconditioned ground of mind.",
      "Let stillness reveal itself.","Rest as the space in which sensations arise.","Let the vividness of experience rest on its own.",
      "Do nothing and let awareness remain as it is.","Rest in the inseparability of openness and clarity.",
      "Let the ground of being support itself.","Relax all effort, even subtle effort.","Let experience be self-liberating."
    ];

    const anchorCues = [
      "In Dzogchen we discover that the root of the mind is awareness or rigpa. This is our true condition. — Namkhai Norbu Rinpoche",
      "When we recognize that the seemingly object nature of reality is nothing different than the subject nature of mind, which is rigpa, it is called enlightenment. — Dzogchen Ponlop Rinpoche",
      "Whatever arises in the mind … just let it be, and it will naturally release itself. — Patrul Rinpoche",
      "The nature of mind is Buddha from the very beginning. — Padmasambhava",
      "This openness was not created just now. — Traditional Dzogchen teaching",
      "Rest in natural great peace. — Traditional Dzogchen teaching",
      "All phenomena are empty, and the nature of mind is already clear. — Tulku Urgyen Rinpoche",
      "In the state of non-dual awareness, nothing is lacking. — Tulku Urgyen Rinpoche",
      "The mind's essence is like space: limitless, luminous, and ungraspable. — Longchenpa",
      "Know the ground; it is free of all elaboration. — Longchenpa",
      "Those who realize the mind see the essence beyond form. — Saraha",
      "Do not seek outside; the essence is here, present as awareness. — Tilopa",
      "All experiences are manifestations of the innate awareness; recognize it as such. — Tilopa",
      "Whatever you meet, meet it as the display of awareness. — Traditional pointer",
      "Look directly at the mind that knows. — Traditional pointer",
      "Not two — awareness and display are inseparable. — Traditional pointer",
      "Open and empty, this is the natural presence. — Traditional pointer",
      "Do not become attached to the appearance; rest in the openness. — Traditional pointer",
      "The view is the simplicity of what is already present. — Traditional pointer"
    ];

    /* ---------- Mahamudra and Trekchö teaching sequences ---------- */

    const mahamudraSteps = [
      "Sit comfortably. Let the body be at ease, not rigid.",
      "Eyes open, gaze slightly lowered. Chin gently tucked, head a little back.",
      "Relax the jaw. Lips slightly apart, tongue resting on the palate.",
      "Let the breath be natural. In-breath a bit shorter than the out-breath.",
      "Feel the weight of the body supported by the seat. Nothing to hold up.",
      "Let the gaze fall along the line of the nose. Thoughts tend to slow on their own.",
      "Notice how attention follows the gaze. Downward softens, upward speeds up.",
      "Allow the whole posture to settle into a sense of simple presence.",
      "Now notice a faint thought arising. Do not finish it. Just see it appear.",
      "See how that thought dissolves as soon as it appears, leaving nothing behind.",
      "Notice a sensation in the body. It too arises, changes, and vanishes.",
      "Notice a feeling or mood. Watch it move and shift without any solid core.",
      "All of this movement is happening within a background of stillness.",
      "Gently shift attention from the moving content to the unmoving background.",
      "Do this without tightening or searching — simply notice what does not move.",
      "Thoughts, sensations, and emotions are like ripples on a vast, still lake.",
      "The lake itself does not move, even while its surface plays.",
      "Let another thought arise and dissolve. See both the ripple and the lake at once.",
      "Notice that the ripple never leaves the lake; it is only the lake moving as a pattern.",
      "In the same way, movement in the mind never leaves stillness.",
      "Look closely at a single thought: does it have a beginning you can find?",
      "Does it have a solid middle? A stable end?",
      "Or is it just a momentary flicker, noticed and gone?",
      "See how one flicker seems to link to the next, forming a story.",
      "That linking is what we call discursive thought — a chain of tiny pulses.",
      "Now instead of following the chain, rest in the space in which the chain appears.",
      "Notice that this space does not come or go with each thought.",
      "Movement and stillness are not two different substances; they share one essence.",
      "The moving is just stillness playing as movement.",
      "Look between two thoughts. Notice the gap that is clear, open, and already present.",
      "Recognize that this gap is not produced by effort; it is simply revealed when not covered.",
      "Let attention rest in this gap, without trying to hold it.",
      "Even when the next thought arises, it arises inside this same openness.",
      "You do not fall out of the natural state when a thought appears.",
      "You have never left the nature of mind; only noticing wanders.",
      "Let noticing come to rest, as if the mind has sat down in its own place.",
      "There is nothing to improve here, nothing missing, nothing extra to add.",
      "Recognize directly: this open, aware, ungraspable stillness is Mahamudra."
    ];

    const trekchoSteps = [
      "Sit or stand in any stable, relaxed posture. Let the body be natural.",
      "Drop the project of fixing or improving yourself, just for this moment.",
      "Without changing anything, notice that there is simple knowing already here.",
      "Sounds are known, sensations are known, thoughts are known — effortlessly.",
      "Turn gently toward this knowing itself, rather than the objects it knows.",
      "Look directly at the one who is aware. Do you find a shape or color?",
      "You cannot locate awareness as a thing, yet experience is undeniably present.",
      "This presence is self-existing: it did not start just now, and it is not produced by effort.",
      "Let thoughts arise as they wish, like clouds drifting through a wide sky.",
      "Do not follow the thoughts. Do not block the thoughts. Let them be.",
      "Notice how each thought appears in this knowing and dissolves back into it.",
      "The knowing is not stained or improved by any particular thought.",
      "Emotions may surge like weather, but the open sky does not become the storm.",
      "Let sensations, feelings, and images play freely, like reflections in a clear mirror.",
      "The mirror does not prefer one reflection over another.",
      "Now look again at the basic knowing. Is it inside the body or outside?",
      "Notice that 'inside' and 'outside' are just ideas appearing in the same knowing.",
      "Awareness has no edge you can touch, no center you can point to.",
      "This open, centerless knowing is already free of anything you might add.",
      "Whatever appears — thought, sound, sensation — is the display of this very awareness.",
      "There is nothing apart from this display that needs to be found.",
      "See how, the moment you look for a solid self, nothing definite can be located.",
      "That unfindability is not a lack; it is primordial purity.",
      "All elaborate stories about yourself are adornments on this simple knowing.",
      "Trekchö means cutting through that elaboration in a single, direct seeing.",
      "Right now, relax all effort to edit experience. Let it be exactly as it is.",
      "Notice that awareness is not doing anything special; it is naturally present.",
      "Even confusion or doubt appears within this same clarity.",
      "There is no need to remove thoughts to rest in awareness.",
      "Awareness and its display are not two separate things.",
      "Rest as this open, empty, vividly knowing presence, without improving it.",
      "Each time you notice you were caught in a story, simply relax back into this knowing.",
      "The ground has never been altered by the stories that pass across it.",
      "This is Trekchö: relaxing completely into primordial purity, just as you are."
    ];

    const dzogchenPOSteps = [
      "Take one soft inhale and exhale. Let the breath settle into its own rhythm.",
      "Let the gaze relax open — not focused, not unfocused, simply at ease.",
      "Let attention rest wide, without narrowing on any object or sensation.",
      "Notice awareness already present before you try to do anything.",
      "Let effort soften. Openness is not produced — it is revealed.",
      "Allow experiences to appear within awareness without pulling at them.",
      "Look gently for the one who is aware and see that nothing solid is found.",
      "Notice that the searcher is also just an appearance within awareness.",
      "Rest in the openness that remains when you stop aiming attention.",
      "Recognize that trying to look at awareness is still a conceptual gesture.",
      "Instead, let awareness recognize itself by being exactly as it is.",
      "Allow the sense of me to appear just as any other sensation.",
      "Notice that this sense of self is also held within wide open awareness.",
      "See how thoughts about being the doer arise and dissolve on their own.",
      "Let the feeling of ownership relax; nothing here requires a controller.",
      "Notice that awareness is present before the thought of I arises, and after it fades.",
      "Rest as the knowing in which the sense of self appears and disappears.",
      "Let appearances move like reflections on water — vivid and transparent.",
      "Notice that openness does not change when thoughts or self-images move.",
      "Relax all effort to shape experience; natural mind needs no adjustment.",
      "Recognize stillness and movement as inseparable within this clarity.",
      "Simply remain in this uncontrived presence — nothing to hold, nothing to fix."
    ];

    /* ---------- shuffle helper ---------- */
    function createShuffler(arr){
      let pool = [...arr];
      return function(){
        if(pool.length === 0) pool = [...arr];
        const idx = Math.floor(Math.random()*pool.length);
        const item = pool[idx];
        pool.splice(idx,1);
        return item;
      };
    }

    const pickPhenomena = createShuffler(phenomena);
    const pickSpace = createShuffler(spaceCues);
    const pickRevelation = createShuffler(revelationCues);
    const pickResting = createShuffler(restingCues);
    const pickAnchor = createShuffler(anchorCues);

    /* ---------- state & elements ---------- */
    let teachingMode = null; // 'dzogchen' | 'mahamudra' | 'trekcho' | null
    let phase = 0;
    const maxPhase = 4;

    let mahaIndex = 0;
    let trekIndex = 0;
    let dzPOIndex = 0;

    const elContent = document.getElementById('content');
    const stepBtn = document.getElementById('stepBtn');
    const cycleBtn = document.getElementById('cycleBtn');
    const anchorBtn = document.getElementById('anchorBtn');
    const anchorText = document.getElementById('anchorText');

    const infoBtn = document.getElementById('infoBtn');
    const soundBtn = document.getElementById('soundBtn');
    soundBtn.style.display = "inline-block";
    const infoModal = document.getElementById('infoModal');
    const infoTitle = document.getElementById('infoTitle');
    const infoBody = document.getElementById('infoBody');
    const closeModal = document.getElementById('closeModal');

    const rushenBtn = document.getElementById('rushenBtn');
    const dzogchenBtn = document.getElementById('dzogchenBtn');
    const mahaBtn = document.getElementById('mahaBtn');
    const trekchoBtn = document.getElementById('trekchoBtn');
    const dzPOBtn  = document.getElementById('dzPOBtn');

    const menuBar = document.getElementById('menuBar');
    const menuToggleBtn = document.getElementById('menuToggleBtn');

    updateSoundUI();
    
    let menuExpanded = true;

    let anchorTimeout = null;

    function clearModeExtras(){
      document.querySelectorAll('.mode-extra-button').forEach(btn => btn.remove());
    }

    /* fade helpers */
    function fadeTextFast(newText){ // Dzogchen: 1000ms
      elContent.style.transition = 'opacity 1000ms ease';
      elContent.style.opacity = '0';
      setTimeout(()=>{
        elContent.textContent = newText;
        elContent.style.opacity = '1';
      }, 800);
    }

    function fadeTextSlow(newText){ // Trekchö + Mahamudra: 1500ms
      elContent.style.transition = 'opacity 1500ms ease';
      elContent.style.opacity = '0';
      setTimeout(()=>{
        elContent.textContent = newText;
        elContent.style.opacity = '1';
      }, 1500);
    }

    /* ---------- sound UI ---------- */
    function updateSoundUI(){
      if(!soundBtn) return;
      soundBtn.style.opacity = soundEnabled ? '1' : '0.75';
      soundBtn.style.backgroundImage = "url('" + (soundEnabled ? SOUND_ICON_ON : SOUND_ICON_OFF) + "')";
    }

    soundBtn.addEventListener('click', ()=>{
      soundEnabled = !soundEnabled;
      ensureAudioCtx();
      if(audioCtx.state === "suspended") audioCtx.resume();

      if(soundEnabled){
        if(teachingMode === 'mahamudra' || teachingMode === 'trekcho'){
          //startSchumann();
        }
      } else {
        //stopSchumann();
      }
      updateSoundUI();
    });

    /* ---------- menu toggle ---------- */
    menuToggleBtn.addEventListener('click', ()=>{
      menuExpanded = !menuExpanded;
      menuBar.style.display = menuExpanded ? 'flex' : 'none';
    });

    function collapseMenu(){
      menuExpanded = false;
      menuBar.style.display = 'none';
    }

    function expandMenu(){
      menuExpanded = true;
      menuBar.style.display = 'flex';
    }

    /* ---------- mode setters ---------- */

    function showDzogchenControls(){
      stepBtn.style.display = 'inline-block';
      cycleBtn.style.display = 'inline-block';
      anchorBtn.style.display = 'inline-block';
      stepBtn.disabled = false;
      cycleBtn.disabled = true;
      anchorBtn.disabled = true;
      infoBtn.style.display = 'inline-block';
      soundBtn.style.display = 'inline-block';
    }

    function showMahamudraControls(){
      stepBtn.style.display = 'inline-block';
      cycleBtn.style.display = 'none';
      anchorBtn.style.display = 'none';
      stepBtn.disabled = false;
      cycleBtn.disabled = true;
      anchorBtn.disabled = true;
      infoBtn.style.display = 'inline-block';
      soundBtn.style.display = 'inline-block';
      //if(soundEnabled) /*startSchumann();*/
    }

    function showTrekchoControls(){
      stepBtn.style.display = 'inline-block';
      cycleBtn.style.display = 'none';
      anchorBtn.style.display = 'none';
      stepBtn.disabled = false;
      cycleBtn.disabled = true;
      anchorBtn.disabled = true;
      infoBtn.style.display = 'inline-block';
      soundBtn.style.display = 'inline-block';
      //if(soundEnabled) /*startSchumann();*/
    }

    function showDzogchenPOControls(){
      stepBtn.style.display = 'inline-block';
      cycleBtn.style.display = 'none';
      anchorBtn.style.display = 'none';
      stepBtn.disabled = false;
      cycleBtn.disabled = true;
      anchorBtn.disabled = true;
      infoBtn.style.display = 'inline-block';
      soundBtn.style.display = 'inline-block';
      //if(soundEnabled) /*startSchumann();*/
    }

    function setModeDzogchen(){
      teachingMode = 'dzogchen';
      phase = 0;
      clearModeExtras();
      ///*stopSchumann();*/ // no continuous hum in Dzogchen
      showDzogchenControls();
      fadeTextFast('Click the left dot (●) to step through the first iteration.');
      collapseMenu();
      playChime();
    }

    function setModeMahamudra(){
      teachingMode = 'mahamudra';
      mahaIndex = 0;
      clearModeExtras();
      showMahamudraControls();
      fadeTextSlow('Mahamudra Pointing-Out — click the dot (●) to begin.');
      collapseMenu();
      playChime();
    }

    function setModeDzogchenPO(){
      teachingMode = 'dzogchenPO';
      dzPOIndex = 0;
      clearModeExtras();
      showDzogchenPOControls();
      fadeTextSlow('Dzogchen Pointing-Out — click the dot (●) to begin.');
      collapseMenu();
      playChime();
    }

    function setModeTrekcho(){
      teachingMode = 'trekcho';
      trekIndex = 0;
      clearModeExtras();
      showTrekchoControls();
      fadeTextSlow('Trekchö — click the dot (●) to begin.');
      collapseMenu();
      playChime();
    }

    dzogchenBtn.addEventListener('click', setModeDzogchen);
    mahaBtn.addEventListener('click', setModeMahamudra);
    trekchoBtn.addEventListener('click', setModeTrekcho);
    dzPOBtn.addEventListener('click', setModeDzogchenPO);
    rushenBtn.addEventListener('click', () => {
      teachingMode = "rushen";
      playChime();
      collapseMenu();
    
      stepBtn.disabled = true;   // locked until method chosen
      cycleBtn.disabled = true;
      anchorBtn.disabled = true;
    
      currentRushenIndex = 0;
      currentRushenPath = null;
    
      fade(rushenIntro[currentRushenIndex]);
    
      showRushenMethodButtons();
    });
    
    /* ---------- info modal content ---------- */
    function setInfoContent(){
      if(teachingMode === 'mahamudra'){
        infoTitle.textContent = 'Mahamudra Pointing-Out';
        infoBody.innerHTML = "<p>This module walks you through a Mahamudra-style pointing-out sequence in small, experiential steps. It emphasizes recognizing the basic clarity of mind within ordinary experience.</p><p>Click the left dot (●) to move through the steps. When the teaching completes, you can choose another module from the menu.</p>";
      } else if(teachingMode === 'dzogchenPO'){
        infoTitle.textContent = 'Dzogchen Pointing-Out';
        infoBody.innerHTML = "<p>This module distills a Dzogchen pointing-out instruction into short, direct steps. It emphasizes relaxing attention wide open, seeing the sense of self as an appearance within awareness, and recognizing natural mind without effort.</p><p>Click the left dot (●) to move through the steps at your own pace. When the teaching completes, you can choose another module from the menu.</p>";
      } else if(teachingMode === 'trekcho'){
        infoTitle.textContent = 'Trekchö Cutting-Through';
        infoBody.innerHTML = "<p>This module offers a simple Trekchö-style cutting-through: relaxing all effort, recognizing the basic knowing already here, looking directly at awareness, and seeing the unfindable yet vivid nature of self and phenomena.</p><p>The steps do not build a state; they point again and again to primordial purity (kadak) as it is. Let the lines land lightly; rest as the open, aware presence they indicate.</p>";
      } else if(teachingMode === 'dzogchen'){
        infoTitle.textContent = 'Dzogchen Freeform';
        infoBody.innerHTML = "<p>Dzogchen Freeform steps through four phases with the left dot: <em>phenomenon → space → revelation → rest</em>. Each iteration invites you to notice a concrete appearance, then the space that holds it, then the nature of that openness, and finally a short period of resting.</p><p>When one full iteration is complete, the left dot disables and the right dot becomes available to start the next iteration. At that same moment an anchor (a short lineage quote) becomes available — press it once to receive a pointer that fades in and out over 30 seconds.</p><p>These are pointers only, not a substitute for direct instruction with a qualified teacher.</p>";
      }
      else if (teachingMode === "rushen") {
        infoTitle.textContent = "Inner Mind Rushen* (Preliminary Practice)";
        infoBody.innerHTML =
          "<p>Inner Mind Rushen is a foundational Dzogchen preliminary used to clear habitual obscurations and prepare attention for direct recognition. It is recommended as the first module for new users.</p>";
      }
    }

    infoBtn.addEventListener('click', ()=>{
      if(!teachingMode) return;
      setInfoContent();
      infoModal.style.display = 'flex';
      infoModal.setAttribute('aria-hidden','false');
    });

    closeModal.addEventListener('click', ()=>{
      infoModal.style.display = 'none';
      infoModal.setAttribute('aria-hidden','true');
    });

    /* ---------- interactions ---------- */
    function fade(newText){
      elContent.style.transition = 'opacity 1500ms ease';
      elContent.style.opacity = '0';
      setTimeout(()=>{
        elContent.textContent = newText;
        elContent.style.opacity = '1';
      }, 1500);
    }
    
    function step(){
      if(stepBtn.disabled || !teachingMode) return;

      if (teachingMode === "rushen") {
        // Intro phase before branching
        if (!currentRushenPath) {
          if (currentRushenIndex < rushenIntro.length) {
            fade(rushenIntro[currentRushenIndex]);
            currentRushenIndex++;
            return;
          } else {
            return; // waiting for method choice
          }
        }
      
        // After method selection
        let arr = currentRushenPath === "wide" ? rushenWide : rushenImagery;
      
        if (currentRushenIndex < arr.length) {
          fade(arr[currentRushenIndex]);
          currentRushenIndex++;
          return;
        }
      
        // Resolution phase
        let offset = currentRushenIndex - arr.length;
        if (offset < rushenResolve.length) {
          fade(rushenResolve[offset]);
          currentRushenIndex++;
          return;
        }
      
        // Completed module
        playChime();
        fade("Inner Mind Rushen complete.");
        expandMenu();
        stepBtn.disabled = true;
        cycleBtn.disabled = true;
        anchorBtn.disabled = true;
        teachingMode = null;
        return;
      }
      
      // Mahamudra mode
      if(teachingMode === 'mahamudra'){
        if(mahaIndex < mahamudraSteps.length){
          fadeTextSlow(mahamudraSteps[mahaIndex++]);
          if(mahaIndex >= mahamudraSteps.length){
            stepBtn.disabled = true;
            showMahamudraCompletion();
          }
        }
        return;
      }

      // Trekchö mode
      if(teachingMode === 'trekcho'){
        if(trekIndex < trekchoSteps.length){
          fadeTextSlow(trekchoSteps[trekIndex++]);
          if(trekIndex >= trekchoSteps.length){
            stepBtn.disabled = true;
            showTrekchoCompletion();
          }
        }
        return;
      }

      // Dzogchen Pointing-Out mode
      if(teachingMode === 'dzogchenPO'){
        if(dzPOIndex < dzogchenPOSteps.length){
          fadeTextSlow(dzogchenPOSteps[dzPOIndex++]);
          if(dzPOIndex >= dzogchenPOSteps.length){
            stepBtn.disabled = true;
            showDzogchenPOCompletion();
          }
        }
        return;
      }

      // Dzogchen freeform mode
      if(teachingMode === 'dzogchen'){
        let text = '';
        if(phase === 0) text = pickPhenomena();
        else if(phase === 1) text = pickSpace();
        else if(phase === 2) text = pickRevelation();
        else if(phase === 3) text = pickResting();

        /*playPhaseTone(phase);*/
        fadeTextFast(text);
        phase++;

        if(phase >= maxPhase){
          // iteration complete
          stepBtn.disabled = true;
          cycleBtn.disabled = false;
          anchorBtn.disabled = false;
        }
        return;
      }
    }

    function cycle(){
      if(cycleBtn.disabled || teachingMode !== 'dzogchen') return;

      // start next Dzogchen iteration
      phase = 0;
      cycleBtn.disabled = true;
      anchorBtn.disabled = true;
      stepBtn.disabled = false;

      /*playPhaseTone(0);*/
      fadeTextFast(pickPhenomena());
      phase = 1;
    }

    function showAnchor(){
      if(anchorBtn.disabled || teachingMode !== 'dzogchen') return;

      anchorBtn.disabled = true;

      if(anchorTimeout) {
        clearTimeout(anchorTimeout);
        anchorTimeout = null;
      }

      anchorText.textContent = pickAnchor();
      playChime();
      anchorText.style.opacity = '1';

      anchorTimeout = setTimeout(()=>{
        anchorText.style.opacity = '0';
        anchorTimeout = setTimeout(()=>{
          anchorText.textContent = '';
          if(!cycleBtn.disabled) anchorBtn.disabled = false;
          anchorTimeout = null;
        }, 15000);
      }, 15000);
    }

    function showMahamudraCompletion(){
      fadeTextSlow('Mahamudra teaching complete.');
      stepBtn.disabled = true;
      expandMenu();
      playChime();
    }

    function showTrekchoCompletion(){
      fadeTextSlow('Trekchö teaching complete.');
      stepBtn.disabled = true;
      expandMenu();
      playChime();
    }

    function showDzogchenPOCompletion(){
      fadeTextSlow('Dzogchen Pointing-Out teaching complete.');
      stepBtn.disabled = true;
      expandMenu();
      playChime();
    }

    function showRushenMethodButtons() {
      const card = document.getElementById("card");
    
      const wideBtn = document.createElement("button");
      wideBtn.textContent = "Wide Attention Method";
      wideBtn.className = "mode-extra-button";
    
      const imagBtn = document.createElement("button");
      imagBtn.textContent = "Imagery Search Method";
      imagBtn.className = "mode-extra-button";
    
      wideBtn.onclick = () => {
        //playChime();
        teachingMode = "rushen";
        currentRushenPath = "wide";
        currentRushenIndex = 0;
        removeRushenMethodButtons();
        stepBtn.disabled = false;
        stepBtn.style.opacity = "1";
        stepBtn.style.pointerEvents = "auto";
        
        //dot.style.opacity = "1";
        //textArea.style.opacity = "1";
      
        fade("Wide Attention — click the dot (●) to continue.");
      };
    
      imagBtn.onclick = () => {
        //playChime();
        teachingMode = "rushen";
        currentRushenPath = "imagery";
        currentRushenIndex = 0;
        removeRushenMethodButtons();
        stepBtn.disabled = false;
        stepBtn.style.opacity = "1";
        stepBtn.style.pointerEvents = "auto";
        
        //dot.style.opacity = "1";
        //textArea.style.opacity = "1";
      
        fade("Imagery Search — click the dot (●) to continue.");
      };
    
      card.appendChild(wideBtn);
      card.appendChild(imagBtn);
    }
    
    function removeRushenMethodButtons() {
      const wideBtn = document.getElementById("rushenWideBtn");
      const imagBtn = document.getElementById("rushenImagBtn");
      if (wideBtn) wideBtn.remove();
      if (imagBtn) imagBtn.remove();
    }

    /* ---------- wiring ---------- */
    stepBtn.addEventListener('click', step);
    cycleBtn.addEventListener('click', cycle);
    anchorBtn.addEventListener('click', showAnchor);

    document.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' || e.key === ' ') {
        if(!stepBtn.disabled && teachingMode) { e.preventDefault(); step(); }
        else if(!cycleBtn.disabled && teachingMode === 'dzogchen') { e.preventDefault(); cycle(); }
      }
      if(e.key === 'a' || e.key === 'A'){ if(!anchorBtn.disabled && teachingMode === 'dzogchen') showAnchor(); }
      if(e.key === 'i' || e.key === 'I'){
        if(!teachingMode) return;
        setInfoContent();
        infoModal.style.display = (infoModal.style.display === 'flex' ? 'none' : 'flex');
      }
    });

    // initial state: menu expanded, no teaching selected; controls + info hidden
    menuBar.style.display = 'flex';
    stepBtn.disabled = true;
    cycleBtn.disabled = true;
    anchorBtn.disabled = true;
    infoBtn.style.display = 'none';
    soundBtn.style.display = 'none';
    soundBtn.style.backgroundImage = "url('" + SOUND_ICON_OFF + "')";
    updateSoundUI();
  </script>
</body>
</html>
